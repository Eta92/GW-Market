<div class="order-modal font-fritz" (click)="$event.stopPropagation()">
  <!-- Modal Header -->
  <div class="modal-header">
    <div class="header-left">
      <div class="item-preview" [class.empty]="!item" [class.has-item]="item">
        <img *ngIf="item" [src]="getImageSource(item)" [alt]="item?.name" />
        <i *ngIf="!item" class="fa fa-cube"></i>
      </div>
      <div class="header-title">
        <h2>{{ confirm || 'Place Order' }}</h2>
        <div class="item-name" *ngIf="item">{{ item.name }}</div>
        <div class="item-name empty" *ngIf="!item">Select an item below</div>
      </div>
    </div>
    <button class="close-btn" (click)="cancelOrder()" title="Close">
      <i class="fa fa-times"></i>
    </button>
  </div>

  <!-- Search Section -->
  <div class="search-section" *ngIf="!maskSearch">
    <app-select-item [width]="800" [height]="160" [offsetY]="-48" (selectItem)="onSelectItem($event)"></app-select-item>
  </div>

  <!-- Modal Body -->
  <div class="modal-body" [formGroup]="form">
    <!-- Order Type Selection - Card Style -->
    <div class="order-type-section">
      <div class="section-label">What do you want to do?</div>
      <div class="order-type-cards">
        <button
          class="order-type-card sell"
          [class.active]="form.get('orderType')?.value === OrderType.SELL"
          (click)="form.patchValue({ orderType: OrderType.SELL })"
        >
          <div class="card-icon">
            <i class="fa fa-arrow-up"></i>
          </div>
          <div class="card-content">
            <span class="card-title">Sell Item</span>
            <span class="card-desc">List an item for sale</span>
          </div>
          <div class="card-check">
            <i
              class="fa"
              [class.fa-circle]="form.get('orderType')?.value !== OrderType.SELL"
              [class.fa-check-circle]="form.get('orderType')?.value === OrderType.SELL"
            ></i>
          </div>
        </button>
        <button
          class="order-type-card buy"
          [class.active]="form.get('orderType')?.value === OrderType.BUY"
          (click)="form.patchValue({ orderType: OrderType.BUY })"
        >
          <div class="card-icon">
            <i class="fa fa-arrow-down"></i>
          </div>
          <div class="card-content">
            <span class="card-title">Buy Item</span>
            <span class="card-desc">Post a buy request</span>
          </div>
          <div class="card-check">
            <i
              class="fa"
              [class.fa-circle]="form.get('orderType')?.value !== OrderType.BUY"
              [class.fa-check-circle]="form.get('orderType')?.value === OrderType.BUY"
            ></i>
          </div>
        </button>
      </div>
    </div>

    <!-- Quantity & Visibility Row -->
    <div class="details-row">
      <div class="form-group quantity-group">
        <label>Quantity</label>
        <app-qty-input formControlName="quantity" [min]="1" [max]="9999"></app-qty-input>
      </div>

      <div class="form-group visibility-group">
        <label>Visibility</label>
        <app-toggle-group
          [options]="visibilityOptions"
          [value]="form.get('hidden')?.value"
          (valueChange)="form.patchValue({ hidden: $event })"
        ></app-toggle-group>
      </div>
    </div>

    <!-- Weapon Details (conditional) -->
    <div class="weapon-section" *ngIf="isWeapon && formWeapon" [formGroup]="formWeapon">
      <div class="weapon-header">
        <i class="fa fa-shield-halved"></i>
        <span>Weapon Specifications</span>
      </div>

      <div class="form-row">
        <div *ngIf="!isLocked" class="form-group" style="flex: 2">
          <label>Attribute</label>
          <select class="form-select" formControlName="attribute">
            <option [ngValue]="'any'">Any / Default</option>
            <option *ngFor="let attr of attributes" [ngValue]="attr">{{ attr }}</option>
          </select>
        </div>
        <div class="form-group" style="flex: 1">
          <label>Requirement</label>
          <input type="number" class="form-input" formControlName="requirement" min="0" max="13" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group" style="flex: 2">
          <label>Core Modification</label>
          <select class="form-select" formControlName="core">
            <option [ngValue]="null">None</option>
            <option *ngFor="let core of weaponLists.core" [ngValue]="core">{{ core }}</option>
          </select>
        </div>
        <div class="form-group" style="flex: 2">
          <label>Inscription</label>
          <app-toggle-group
            [options]="[
              { value: true, label: 'Inscribable', icon: 'fa-scroll' },
              { value: false, label: 'Classic' }
            ]"
            [value]="formWeapon.get('inscription')?.value"
            (valueChange)="formWeapon.patchValue({ inscription: $event })"
          ></app-toggle-group>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Prefix</label>
          <select class="form-select" formControlName="prefix">
            <option [ngValue]="null">None</option>
            <option *ngFor="let prefix of weaponLists.prefix" [ngValue]="prefix">{{ prefix }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Suffix</label>
          <select class="form-select" formControlName="suffix">
            <option [ngValue]="null">None</option>
            <option *ngFor="let suffix of weaponLists.suffix" [ngValue]="suffix">{{ suffix }}</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Miniature Details (conditional) -->
    <div class="miniature-section" *ngIf="isMiniature" [formGroup]="formOther">
      <div class="weapon-header">
        <i class="fa fa-star"></i>
        <span>Miniature Details</span>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Dedication Status</label>
          <app-toggle-group
            [options]="[
              { value: false, label: 'Undedicated' },
              { value: true, label: 'Dedicated' }
            ]"
            [value]="formOther.get('dedicated')?.value"
            (valueChange)="formOther.patchValue({ dedicated: $event })"
          ></app-toggle-group>
        </div>
      </div>
    </div>

    <!-- Advanced Settings -->
    <div class="advanced-section" [formGroup]="formOther">
      <div class="advanced-toggle" (click)="isAdvanced = !isAdvanced">
        <i class="fa fa-gear"></i>
        <span>Advanced Options</span>
        <i class="fa" [class.fa-chevron-down]="!isAdvanced" [class.fa-chevron-up]="isAdvanced"></i>
      </div>
      <div class="advanced-content" *ngIf="isAdvanced">
        <div class="form-row">
          <div class="form-group">
            <label>Pre-Searing Item</label>
            <app-toggle-group
              [options]="[
                { value: false, label: 'Normal' },
                { value: true, label: 'Pre-Searing' }
              ]"
              [value]="formOther.get('pre')?.value"
              (valueChange)="formOther.patchValue({ pre: $event })"
            ></app-toggle-group>
          </div>
          <div class="form-group">
            <label>Pre-Nerf Item</label>
            <app-toggle-group
              [options]="[
                { value: false, label: 'Normal' },
                { value: true, label: 'Legacy' }
              ]"
              [value]="formOther.get('legacy')?.value"
              (valueChange)="formOther.patchValue({ legacy: $event })"
            ></app-toggle-group>
          </div>
        </div>
      </div>
    </div>

    <!-- Pricing Section -->
    <div class="pricing-section">
      <div class="section-label">
        <span>{{ form.get('orderType')?.value === OrderType.SELL ? 'Asking Price' : 'Willing to Pay' }}</span>
      </div>
      <div class="prices-container" formArrayName="prices">
        <div class="price-card" *ngFor="let price of getprices().controls; let i = index" [formGroupName]="i">
          <div class="price-field currency-field">
            <label>Currency</label>
            <app-currency-dropdown
              [selectedCurrency]="price.get('type')?.value"
              (currencyChange)="selectCurrency(i, $event)"
            ></app-currency-dropdown>
          </div>
          <div class="price-inputs">
            <div class="price-field">
              <label>Per Unit</label>
              <div class="input-with-icon">
                <img class="input-currency-icon" [src]="price.get('type')?.value | currencySource" alt="" />
                <input type="number" class="form-input price-input" formControlName="unit" min="0" placeholder="0" />
              </div>
            </div>
            <div class="price-field">
              <label>Total</label>
              <div class="input-with-icon">
                <img class="input-currency-icon" [src]="price.get('type')?.value | currencySource" alt="" />
                <input type="number" class="form-input price-input" formControlName="price" min="0" placeholder="0" />
              </div>
            </div>
          </div>
          <button
            type="button"
            class="remove-price-btn"
            *ngIf="getprices().controls.length > 1"
            (click)="removePrice(i)"
            title="Remove"
          >
            <i class="fa fa-times"></i>
          </button>
        </div>
        <button type="button" class="add-price-btn" (click)="addPrice()">
          <i class="fa fa-plus"></i>
          <span>Add Currency</span>
        </button>
      </div>
    </div>

    <!-- Description -->
    <div class="description-section">
      <div class="section-label">Additional Notes</div>
      <textarea
        class="form-textarea"
        formControlName="description"
        placeholder="Add any extra details about your order..."
        rows="3"
      ></textarea>
    </div>
  </div>

  <!-- Modal Footer -->
  <div class="modal-footer">
    <button class="cancel-btn" (click)="cancelOrder()">
      <i class="fa fa-times"></i>
      Cancel
    </button>
    <button
      class="confirm-btn"
      [class.sell]="form.get('orderType')?.value === OrderType.SELL"
      [class.buy]="form.get('orderType')?.value === OrderType.BUY"
      (click)="validateOrder()"
    >
      <i
        class="fa"
        [class.fa-arrow-up]="form.get('orderType')?.value === OrderType.SELL"
        [class.fa-arrow-down]="form.get('orderType')?.value === OrderType.BUY"
      ></i>
      {{ confirm || 'Create Order' }}
    </button>
  </div>
</div>
