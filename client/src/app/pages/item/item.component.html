<div class="item-page scroll font-fritz">
  <!-- HEADER -->
  <app-header
    [showSearch]="true"
    [showFeatures]="false"
    [compact]="true"
    (placeOrder)="orderOpen = true"
    (selectItem)="onSelectItem($event)"
  ></app-header>

  <!-- MAIN LAYOUT: Sidebar + Content -->
  <div class="page-layout">
    <!-- ITEM SIDEBAR (Left on desktop, top on mobile) -->
    <aside class="item-sidebar">
      <div class="sidebar-inner">
        <!-- Item Visual -->
        <div class="item-visual">
          <div class="item-frame">
            <img class="item-image" [src]="getImageSource(item)" [alt]="item?.name" />
          </div>
        </div>

        <!-- Item Info -->
        <div class="item-info">
          <h1 class="item-name">{{ item?.name || 'Loading...' }}</h1>
          <div class="item-meta" *ngIf="details.length > 0">
            <div class="meta-tag" *ngFor="let detail of details">
              <span class="meta-text">{{ detail }}</span>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="sidebar-stats">
          <div class="stat-row">
            <span class="stat-icon sell"><i class="fa fa-arrow-up"></i></span>
            <span class="stat-label">Selling</span>
            <span class="stat-value">{{ getTotalSellOrders() }}</span>
          </div>
          <div class="stat-row">
            <span class="stat-icon buy"><i class="fa fa-arrow-down"></i></span>
            <span class="stat-label">Buying</span>
            <span class="stat-value">{{ getTotalBuyOrders() }}</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- CONTENT AREA -->
    <div class="content-area">
      <!-- FILTER BAR -->
      <section class="filter-bar">
        <div class="filter-group">
          <app-toggle-group
            [options]="orderTypeOptions"
            [value]="orderTypeFilter"
            (valueChange)="setOrderTypeFilter($event)"
          ></app-toggle-group>
        </div>

        <div class="filter-group" *ngIf="availableCurrencies.length > 1">
          <app-toggle-group
            [options]="currencyOptions"
            [value]="currencyFilterValue"
            (valueChange)="onCurrencyFilterChange($event)"
          ></app-toggle-group>
        </div>

        <div class="filter-group view-mode-group" *ngIf="orderTypeFilter === 'all'">
          <app-toggle-group
            [options]="viewModeOptions"
            [value]="viewMode"
            (valueChange)="setViewMode($event)"
          ></app-toggle-group>
        </div>

        <div class="filter-summary">
          <span class="order-total">{{ getFilteredOrderCount() }} orders</span>
        </div>
      </section>

      <!-- ORDERS SECTION -->
      <main class="orders-section bg-sky bg-base">
        <!-- SPLIT SELL/BUY COLUMNS (Separate view mode) - 2 column layout -->
        <div class="split-columns-grid" *ngIf="showSplitColumns">
          <!-- SELL SECTION -->
          <div class="split-section sell-section">
            <h2 class="section-title sell-title">
              <i class="fa fa-arrow-up"></i>
              Sell Orders
              <span class="section-count">({{ getTotalSellOrders() }})</span>
            </h2>
            <div class="split-orders-list scroll">
              <ng-container *ngFor="let timeBucket of getAllSellOrdersByTime()">
                <div
                  class="time-bucket-mini"
                  [class.online-bucket]="timeBucket.time === 0"
                  [class.today-bucket]="timeBucket.time === 1"
                  [class.week-bucket]="timeBucket.time === 2"
                >
                  <div class="time-bucket-label-mini">{{ timeToString(timeBucket.time) }}</div>
                  <app-order-row
                    *ngFor="let order of timeBucket.orders"
                    [order]="order"
                    [type]="'sell'"
                    [hasNote]="!!order.description || hasItemDetails(order)"
                    [showWeaponDetails]="hasItemDetails(order)"
                    (rowClick)="openOrderDetail($event)"
                    (submitVote)="reputationVote($event.order, $event.vote)"
                    (whisperClick)="whisper($event)"
                  ></app-order-row>
                </div>
              </ng-container>
              <div class="empty-section" *ngIf="getTotalSellOrders() === 0">
                <i class="fa fa-inbox"></i>
                <span>No sell orders</span>
              </div>
            </div>
          </div>

          <!-- BUY SECTION -->
          <div class="split-section buy-section">
            <h2 class="section-title buy-title">
              <i class="fa fa-arrow-down"></i>
              Buy Orders
              <span class="section-count">({{ getTotalBuyOrders() }})</span>
            </h2>
            <div class="split-orders-list scroll">
              <ng-container *ngFor="let timeBucket of getAllBuyOrdersByTime()">
                <div
                  class="time-bucket-mini"
                  [class.online-bucket]="timeBucket.time === 0"
                  [class.today-bucket]="timeBucket.time === 1"
                  [class.week-bucket]="timeBucket.time === 2"
                >
                  <div class="time-bucket-label-mini">{{ timeToString(timeBucket.time) }}</div>
                  <app-order-row
                    *ngFor="let order of timeBucket.orders"
                    [order]="order"
                    [type]="'buy'"
                    [hasNote]="!!order.description || hasItemDetails(order)"
                    [showWeaponDetails]="hasItemDetails(order)"
                    (rowClick)="openOrderDetail($event)"
                    (submitVote)="reputationVote($event.order, $event.vote)"
                    (whisperClick)="whisper($event)"
                  ></app-order-row>
                </div>
              </ng-container>
              <div class="empty-section" *ngIf="getTotalBuyOrders() === 0">
                <i class="fa fa-inbox"></i>
                <span>No buy orders</span>
              </div>
            </div>
          </div>
        </div>

        <!-- CURRENCY-BASED LAYOUT (multiple currencies OR filtered to single order type) -->
        <div class="currency-grid" [class.single-currency]="filteredCurrencies.length === 1" *ngIf="!showSplitColumns">
          <!-- CURRENCY COLUMNS -->
          <div class="currency-column" *ngFor="let currency of filteredCurrencies">
            <h2 class="column-title currency-title">
              <img [src]="currency.currency | currencySource" [alt]="currency.currencyName" class="currency-icon" />
              {{ currency.currencyName }}
              <span class="order-count" *ngIf="currency.totalOrders">({{ currency.totalOrders }})</span>
            </h2>

            <div class="currency-orders-list scroll" *ngIf="currency.totalOrders > 0">
              <ng-container *ngFor="let timeBucket of currency.timeBuckets">
                <div
                  class="time-bucket"
                  [class.online-bucket]="timeBucket.time === 0"
                  [class.today-bucket]="timeBucket.time === 1"
                  [class.week-bucket]="timeBucket.time === 2"
                  *ngIf="hasOrdersInTimeBucket(timeBucket)"
                >
                  <div class="time-bucket-header">
                    <span class="time-bucket-label">{{ timeToString(timeBucket.time) }}</span>
                    <span class="time-bucket-count">
                      {{ timeBucket.sellOrders.length + timeBucket.buyOrders.length }} orders
                    </span>
                  </div>

                  <!-- SELL ORDERS in this time bucket -->
                  <div class="order-type-group sell-group" *ngIf="showSellOrders() && timeBucket.sellOrders.length > 0">
                    <div class="order-type-label sell-label"><i class="fa fa-arrow-up"></i> Selling</div>
                    <app-order-row
                      *ngFor="let order of timeBucket.sellOrders"
                      [order]="order"
                      [type]="'sell'"
                      [hasNote]="!!order.description || hasItemDetails(order)"
                      [showWeaponDetails]="hasItemDetails(order)"
                      (rowClick)="openOrderDetail($event)"
                      (submitVote)="reputationVote($event.order, $event.vote)"
                      (whisperClick)="whisper($event)"
                    ></app-order-row>
                  </div>

                  <!-- BUY ORDERS in this time bucket -->
                  <div class="order-type-group buy-group" *ngIf="showBuyOrders() && timeBucket.buyOrders.length > 0">
                    <div class="order-type-label buy-label"><i class="fa fa-arrow-down"></i> Buying</div>
                    <app-order-row
                      *ngFor="let order of timeBucket.buyOrders"
                      [order]="order"
                      [type]="'buy'"
                      [hasNote]="!!order.description || hasItemDetails(order)"
                      [showWeaponDetails]="hasItemDetails(order)"
                      (rowClick)="openOrderDetail($event)"
                      (submitVote)="reputationVote($event.order, $event.vote)"
                      (whisperClick)="whisper($event)"
                    ></app-order-row>
                  </div>
                </div>
              </ng-container>
            </div>

            <div class="empty-orders" *ngIf="currency.totalOrders === 0">
              <i class="fa fa-inbox"></i>
              <p>No orders</p>
            </div>
          </div>

          <!-- Empty state when no orders at all -->
          <div class="empty-orders full-width" *ngIf="filteredCurrencies.length === 0">
            <i class="fa fa-inbox"></i>
            <p>No orders for this item</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- FOOTER -->
  <app-footer></app-footer>
</div>

<!-- Order Detail Modal -->
<app-modal [isOpen]="!!selectedOrder" (closed)="closeOrderDetail()" contentClass="order-detail-content-wrapper">
  <div
    class="order-detail-content"
    [class.sell-order]="selectedOrder?.orderType === 0"
    [class.buy-order]="selectedOrder?.orderType === 1"
  >
    <div class="order-detail-header">
      <div
        class="order-type-badge"
        [class.sell]="selectedOrder?.orderType === 0"
        [class.buy]="selectedOrder?.orderType === 1"
      >
        <i
          class="fa"
          [class.fa-arrow-up]="selectedOrder?.orderType === 0"
          [class.fa-arrow-down]="selectedOrder?.orderType === 1"
        ></i>
        {{ selectedOrder?.orderType === 0 ? 'Selling' : 'Buying' }}
      </div>
      <button class="modal-close" (click)="closeOrderDetail()">
        <i class="fa fa-times"></i>
      </button>
    </div>

    <div class="order-detail-body">
      <!-- Item Info -->
      <div class="detail-item-row">
        <img class="detail-item-img" [src]="getImageSource(item)" [alt]="item?.name" />
        <div class="detail-item-info">
          <span class="detail-item-name">{{ item?.name }}</span>
          <span class="detail-item-qty"
            >Quantity: <strong>{{ selectedOrder?.quantity }}</strong></span
          >
        </div>
      </div>

      <!-- Price Info -->
      <div class="detail-price-section" *ngIf="selectedOrder?.price">
        <div class="detail-price-row">
          <span class="detail-price-label">Total Price</span>
          <div class="detail-price-value">
            <img [src]="selectedOrder.price.type | currencySource" class="detail-currency-icon" />
            <span class="detail-price-amount">{{ selectedOrder.price.price }}</span>
            <span class="detail-currency-name">{{ selectedOrder.price.type | priceToString }}</span>
          </div>
        </div>
        <div class="detail-price-row unit-price">
          <span class="detail-price-label">Price per Item</span>
          <div class="detail-price-value">
            <span class="detail-price-decimal">{{
              selectedOrder.price.price | decimalUnitPrice: selectedOrder.quantity
            }}</span>
            <span class="detail-price-fraction">({{ selectedOrder.div_price }}:{{ selectedOrder.div_quantity }})</span>
          </div>
        </div>
      </div>

      <!-- Seller Info -->
      <div class="detail-seller-section">
        <div class="detail-seller-row">
          <div>
            <span class="detail-seller-label">Player</span>
            <div class="detail-seller-badges">
              <span class="badge online" *ngIf="selectedOrder?.daybreakOnline">
                <img src="/assets/img/online.png" /> Online
              </span>
              <span class="badge certified" *ngIf="selectedOrder?.authCertified">
                <img src="/assets/img/certified.png" /> Certified
              </span>
            </div>
          </div>
          <div class="detail-seller-value -mt-1.5">
            <span class="detail-seller-name">{{ selectedOrder?.player }}</span>
            <div class="detail-actions-right">
              <button
                class="detail-vote-btn positive"
                (click)="reputationVote(selectedOrder, 'positive')"
                title="Positive vote"
              >
                <span>{{ selectedOrder?.positives }}</span>
                <i class="fa fa-thumbs-up"></i>
              </button>
              <button
                class="detail-vote-btn negative"
                (click)="reputationVote(selectedOrder, 'negative')"
                title="Negative vote"
              >
                <span>{{ selectedOrder?.negatives }}</span>
                <i class="fa fa-thumbs-down mt-1.5"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="detail-seller-row" *ngIf="selectedOrder?.lastRefresh">
          <span class="detail-seller-label">Last Updated</span>
          <span class="detail-seller-time">{{ selectedOrder.lastRefresh | formatLastUpdate }}</span>
        </div>
      </div>

      <!-- Item Details (weapon, miniature, pre-searing) -->
      <div class="detail-item-details-section" *ngIf="selectedOrder && hasItemDetails(selectedOrder)">
        <app-item-details [item]="selectedOrder.item" [details]="selectedOrder.details"></app-item-details>
      </div>

      <!-- Notes Section (description only) -->
      <div class="detail-notes-section" *ngIf="selectedOrder?.description">
        <span class="detail-notes-label">Notes</span>
        <div class="detail-notes-content">
          <p class="detail-description">{{ selectedOrder.description }}</p>
        </div>
      </div>
    </div>

    <div class="order-detail-footer">
      <button class="detail-whisper-btn" (click)="whisperFromDetail()">
        <i class="fa fa-comment"></i>
        Contact {{ selectedOrder?.player }}
      </button>
    </div>
  </div>
</app-modal>

<!-- Whisper Popup -->
<app-modal [isOpen]="popup" (closed)="popup = false" contentClass="whisper-popup-content">
  <div class="popup-content">
    <div class="popup-header">
      <img class="popup-img" [src]="getImageSource(item)" />
      <div class="popup-title">
        <h3>Contact Player</h3>
        <p>Copy message to whisper in-game</p>
      </div>
      <button class="popup-close" (click)="popup = false">
        <i class="fa fa-times"></i>
      </button>
    </div>

    <!-- Quantity Slider Section -->
    <div class="popup-slider-section" *ngIf="selectedWhisperOrder && selectedWhisperOrder.quantity > 1">
      <div class="slider-header">
        <span class="slider-label">Quantity</span>
        <span class="slider-value">{{ whisperQuantity }} / {{ selectedWhisperOrder.quantity }}</span>
      </div>
      <input
        type="range"
        class="quantity-slider"
        [min]="1"
        [max]="selectedWhisperOrder.quantity"
        [step]="1"
        [(ngModel)]="whisperQuantity"
        (input)="updateTradeMessage()"
      />
      <div class="slider-price-info" *ngIf="selectedWhisperOrder.price">
        <span>Total: </span>
        <img [src]="selectedWhisperOrder.price.type | currencySource" class="slider-currency-icon" />
        <span class="slider-price">{{ calculatePartialPrice() }}</span>
      </div>
    </div>

    <textarea class="popup-textarea" #area (focus)="area.select()" readonly>{{ tradeMessage }}</textarea>
    <button class="confirm-btn" title="Copy to clipboard" (click)="copyMessage()">
      <i class="fa fa-copy"></i>
      Copy Trade Message
    </button>
  </div>
</app-modal>

<!-- Place Order Modal -->
<app-new-order
  [preselect]="item"
  [orderOpen]="orderOpen"
  (createOrder)="onCreateOrder($event)"
  (closeOrder)="orderOpen = false"
></app-new-order>
