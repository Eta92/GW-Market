<div class="marketplace-layout font-fritz scroll" (click)="searchOpen = false">
  <!-- HERO HEADER with Guild Wars Background -->
  <app-header
    [hero]="true"
    [showFeatures]="true"
    (placeOrder)="orderOpen = true"
    (selectItem)="goToItem($event)"
  ></app-header>

  <!-- MAIN CONTENT -->
  <main class="main-content bg-sky bg-base">
    <div class="content-wrapper">
      <!-- Categories Section -->
      <section class="categories-section">
        <div class="section-header">
          <!-- Title Row -->
          <div class="title-row">
            <h2 class="section-title">
              <i class="fa fa-th-large"></i>
              <span *ngIf="availableList === 'family'">Item Categories</span>
              <span *ngIf="availableList === 'category'">{{ availableFamily?.name }}</span>
              <span *ngIf="availableList === 'item'">{{ availableCategory?.name }}</span>
            </h2>

            <!-- Breadcrumb -->
            <nav class="breadcrumb" *ngIf="availableList !== 'family'">
              <span class="crumb clickable" (click)="goToAll()">All</span>
              <i class="fa fa-angle-right sep"></i>
              <span
                class="crumb"
                [class.clickable]="availableList === 'item'"
                (click)="availableList === 'item' && goToFamily(availableFamily)"
              >{{ availableFamily?.name }}</span>
              <ng-container *ngIf="availableList === 'item'">
                <i class="fa fa-angle-right sep"></i>
                <span class="crumb current">{{ availableCategory?.name }}</span>
              </ng-container>
            </nav>
          </div>

          <!-- Filter Row -->
          <div class="filter-row">
            <!-- Filters -->
            <app-toggle-group
              [options]="availableModeOptions"
              [value]="availableMode"
              (valueChange)="availableMode = $event"
            ></app-toggle-group>

            <!-- Time Filter -->
            <app-toggle-group
              [options]="timeModeOptions"
              [value]="timeMode"
              (valueChange)="timeMode = $event"
              styleClass="time-filter"
            ></app-toggle-group>

            <!-- View Mode Toggle -->
            <app-toggle-group
              [options]="viewModeOptions"
              [value]="viewMode"
              (valueChange)="viewMode = $event"
              styleClass="compact"
            ></app-toggle-group>
          </div>
        </div>

        <!-- Cards Grid -->
        <div class="cards-container scroll" [class.list-mode]="viewMode === 'list'">
          <!-- ========== GRID VIEW ========== -->
          <ng-container *ngIf="viewMode === 'grid'">
            <!-- Family Cards -->
            <div *ngIf="availableList === 'family'" class="cards-grid">
              <app-preview-card
                *ngFor="let family of active(availableTree.families)"
                [previews]="getPreviewSources(family.previews)"
                [label]="family.name"
                [stats]="getStats(family)"
                [statsMode]="timeMode === 'combined' ? 'combined' : 'basic'"
                (cardClick)="goToFamily(family)"
              ></app-preview-card>
            </div>

            <!-- Category Cards -->
            <div *ngIf="availableList === 'category'" class="cards-grid">
              <app-preview-card
                *ngFor="let category of active(availableFamily.categories)"
                [previews]="getPreviewSources(category.previews)"
                [label]="category.name"
                [stats]="getStats(category)"
                [statsMode]="timeMode === 'combined' ? 'combined' : 'basic'"
                (cardClick)="goToCategory(category)"
              ></app-preview-card>
            </div>

            <!-- Item Cards -->
            <div *ngIf="availableList === 'item'" class="cards-grid items">
              <app-preview-card
                *ngFor="let item of active(availableCategory.items)"
                [previews]="[getPreviewSource(item.name)]"
                [label]="item.name"
                [stats]="getStats(item)"
                [statsMode]="timeMode === 'combined' ? 'combined' : 'basic'"
                [isSingleImage]="true"
                [smallLabel]="true"
                (cardClick)="goToItem(item)"
              ></app-preview-card>
            </div>
          </ng-container>

          <!-- ========== LIST VIEW (Explorer Style) ========== -->
          <ng-container *ngIf="viewMode === 'list'">
            <!-- Family List -->
            <div *ngIf="availableList === 'family'" class="explorer-list">
              <div
                *ngFor="let family of active(availableTree.families)"
                class="explorer-item frame"
                (click)="goToFamily(family)"
              >
                <img class="explorer-icon" [src]="getPreviewSource(family.previews?.[0])" [alt]="family.name" />
                <span class="explorer-name">{{ family.name }}</span>
                <span class="explorer-count">{{ family.categories?.length || 0 }} categories</span>
                <app-stats-display [mode]="timeMode === 'combined' ? 'combined' : 'basic'" [stats]="getStats(family)" containerClass="explorer-stats"></app-stats-display>
                <i class="fa fa-chevron-right nav-arrow"></i>
              </div>
            </div>

            <!-- Category List -->
            <div *ngIf="availableList === 'category'" class="explorer-list">
              <div
                *ngFor="let category of active(availableFamily.categories)"
                class="explorer-item frame"
                (click)="goToCategory(category)"
              >
                <img class="explorer-icon" [src]="getPreviewSource(category.previews?.[0])" [alt]="category.name" />
                <span class="explorer-name">{{ category.name }}</span>
                <span class="explorer-count">{{ category.items?.length || 0 }} items</span>
                <app-stats-display [mode]="timeMode === 'combined' ? 'combined' : 'basic'" [stats]="getStats(category)" containerClass="explorer-stats"></app-stats-display>
                <i class="fa fa-chevron-right nav-arrow"></i>
              </div>
            </div>

            <!-- Item List -->
            <div *ngIf="availableList === 'item'" class="explorer-list">
              <div
                *ngFor="let item of active(availableCategory.items)"
                class="explorer-item frame"
                (click)="goToItem(item)"
              >
                <img class="explorer-icon" [src]="getPreviewSource(item.name)" [alt]="item.name" />
                <span class="explorer-name">{{ item.name }}</span>
                <app-stats-display [mode]="timeMode === 'combined' ? 'combined' : 'basic'" [stats]="getStats(item)" containerClass="explorer-stats"></app-stats-display>
                <i class="fa fa-chevron-right nav-arrow"></i>
              </div>
            </div>
          </ng-container>
        </div>
      </section>

      <!-- Recent Listings Section -->
      <section class="listings-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fa fa-clock"></i>
            Recent Listings
          </h2>
          <span class="count" *ngIf="lastItems.length">{{ lastItems.length }} items</span>
        </div>

        <div class="listings-container scroll">
          <div
            *ngFor="let shopItem of lastItems"
            class="listing-card frame"
            [class.faded]="(shopItem | oldOpacity) !== ''"
            [class.selling]="shopItem.orderType === OrderType.SELL"
            [class.buying]="shopItem.orderType === OrderType.BUY"
            (click)="goToItem(shopItem)"
          >
            <!-- Badge + Time -->
            <div class="listing-header">
              <span class="order-badge" [class.sell]="shopItem.orderType === OrderType.SELL" [class.buy]="shopItem.orderType === OrderType.BUY">
                {{ shopItem.orderType === OrderType.SELL ? 'WTS' : 'WTB' }}
              </span>
              <span class="listing-time">{{ shopItem.lastRefresh | formatLastUpdate }}</span>
            </div>

            <!-- Item Image -->
            <img class="item-img" [src]="getPreviewSource(shopItem.name)" [alt]="shopItem.name" />

            <!-- Item Details -->
            <div class="listing-item">
              <span class="item-name" [title]="shopItem.name">{{ shopItem.name }}</span>
              <span class="item-qty">Ã—{{ shopItem.quantity }}</span>
            </div>

            <!-- Price -->
            <div class="listing-price">
              <span class="price-header">{{ shopItem.orderType === OrderType.SELL ? 'ASKING' : 'PAYING' }}</span>
              <div class="price-rows">
                <div class="price-row" *ngFor="let price of shopItem.prices">
                  <img class="currency-icon" [src]="price.type | currencySource" [alt]="price.type | priceToString" />
                  <span class="price-amount">{{ price.price.toFixed(2) }}</span>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="lastItems.length === 0" class="empty-state">
            <i class="fa fa-inbox"></i>
            <p>No recent listings</p>
          </div>
        </div>
      </section>
    </div>
  </main>

  <app-footer></app-footer>

  <app-new-order [orderOpen]="orderOpen" (createOrder)="onCreateOrder($event)" (closeOrder)="orderOpen = false"></app-new-order>
</div>
